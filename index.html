<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>å‘±å‘±çš„æˆé•¿ç®¡å®¶ Â· 2025.5.28å‡ºç”Ÿ</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"PingFang SC",sans-serif;background:#fffaf7;margin:0;padding:0 15px;color:#333;line-height:1.6;}
  .header{text-align:center;padding:28px 0;background:linear-gradient(135deg,#ffb3ba,#ffdfba);color:#fff;margin:-15px -15px 25px;border-radius:0 0 30px 30px;}
  .age{font-size:34px;font-weight:bold;margin:10px 0;color:#3388ff;} /* è“è‰²å­—ä½“å®šåˆ¶ */
  .section{margin:22px 0;background:#fff;border-radius:20px;padding:20px;box-shadow:0 8px 30px rgba(255,182,193,.15);}
  h2{margin:0 0 18px;font-size:19px;color:#ff6b81;position:relative;padding-left:15px;}
  h2::before{content:"";position:absolute;left:0;top:4px;width:6px;height:18px;background:#ff6b81;border-radius:3px;}
  .item{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin:14px 0;padding:14px;background:#fff9f5;border-radius:12px;}
  .item-name{flex:1 1 120px;font-size:16px;}
  .item-input{display:flex;gap:6px;align-items:center;}
  .item-input input{width:65px;padding:6px;text-align:center;border:1px solid #ffb3ba;border-radius:8px;font-size:15px;}
  .item-stock{font-weight:bold;color:#ff6b81;font-size:16px;white-space:nowrap;}
  .warn{color:#ff3b30 !important;}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:15px 0;}
  .food{background:#fff9f5;border-radius:12px;padding:12px;text-align:center;font-size:14px;cursor:pointer;transition:.2s;}
  .food.selected{background:#ff8ba7;color:#fff;}
  .tag{display:inline-block;padding:6px 12px;border-radius:20px;font-size:13px;margin:4px 4px 4px 0;}
  .testing{background:#fff3cd;color:#d4380d;}
  .passed{background:#d4edda;color:#155724;}
  .pending{background:#e2e3e5;color:#383d41;}
  canvas{width:100%;height:300px;border-radius:12px;background:#fff9f5;margin:12px 0;}
  .record-item{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;padding:12px;background:#fff9f5;border-radius:10px;margin:8px 0;}
  .countdown{text-align:center;padding:18px;background:#fff1f0;border-radius:15px;}
  .countdown .big{font-size:32px;color:#ff6b81;font-weight:bold;}
  input,select,button{padding:9px 12px;border-radius:8px;font-size:15px;margin:4px 0;}
  input,select{border:1px solid #ffb3ba;}
  button{background:#ff8ba7;color:#fff;border:none;cursor:pointer;}
  .sync-btn{background:#3388ff;margin-top:10px;} /* è“è‰²åŒæ­¥æŒ‰é’® */
  .footer{text-align:center;padding:40px 0;color:#aaa;font-size:14px;}
</style>
</head>
<body>

<div class="header">
  <div class="age" id="ageText">å‘±å‘±ç°åœ¨ 0 ä¸ªæœˆ 0 å¤©</div>
  <div style="font-size:18px;opacity:0.9;">å‡ºç”Ÿï¼š2025å¹´5æœˆ28æ—¥</div>
</div>

<div class="section">
  <h2>ä¸€å‘¨å²å€’è®¡æ—¶</h2>
  <div class="countdown">
    <div>å‘±å‘±è½åœ°ä¸€å‘¨å¹´</div>
    <div class="big" id="to1year">è¿˜å‰© 0 å¤©</div>
  </div>
</div>

<div class="section">
  <h2>ç”Ÿé•¿æ›²çº¿è®°å½•ï¼ˆWHOæ ‡å‡†ï¼‰</h2>
  <canvas id="growthChart"></canvas>
  <details style="margin-top:15px;">
    <summary style="color:#ff6b81;cursor:pointer;">ï¼‹ æ·»åŠ ä½“æ£€æ•°æ®</summary>
    <div style="padding:15px 0;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <input type="date" id="newDate">
      <input type="number" step="0.1" placeholder="èº«é«˜ cm" id="newHeight">
      <input type="number" step="0.1" placeholder="ä½“é‡ kg" id="newWeight">
      <input type="number" step="0.1" placeholder="å¤´å›´ cmï¼ˆå¯é€‰ï¼‰" id="newHead">
      <button onclick="addRecord()" style="grid-column:1/-1;">ç¡®è®¤æ·»åŠ </button>
    </div>
  </details>
  <div id="recordList"></div>
</div>

<div class="section">
  <h2>è€—æåº“å­˜ï¼ˆçº¢å­—=7å¤©å†…ç”¨å®Œï¼‰</h2>
  <div id="supplies"></div>
</div>

<div class="section">
  <h2>6-7æœˆé¾„è¾…é£Ÿè®¡åˆ’</h2>
  <div class="grid" id="foodPool"></div>
  <div style="margin-top:15px;">
    <strong>æœ¬å‘¨è®¡åˆ’</strong>
    <div id="weekPlan" style="min-height:60px;padding:15px;background:#fff9f5;border-radius:12px;margin-top:8px;"></div>
  </div>
</div>

<div class="section">
  <h2>è¾…é£Ÿæ’æ•è®°å½•</h2>
  <div style="margin-bottom:12px;">
    <select id="newAllergy"></select>
    <button onclick="startAllergy()">å¼€å§‹æ’æ•</button>
  </div>
  <div><strong>æ­£åœ¨æ’æ•ï¼š</strong><br><span id="testingList"></span></div>
  <div style="margin-top:12px;"><strong>å·²é€šè¿‡ï¼š</strong><br><span id="passedList"></span></div>
  <div style="margin-top:12px;"><strong>å¾…æ’æ•ï¼š</strong><br><span id="pendingList"></span></div>
</div>

<div class="section">
  <h2>é‡è¦å¾…åŠ</h2>
  <div id="todos"></div>
  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
    <input type="text" id="newTodo" placeholder="ä¾‹å¦‚ï¼š2025.11.28 å…­ä¸ªæœˆå„¿ä¿" style="flex:1;min-width:200px;">
    <button onclick="addTodo()">+ æ·»åŠ </button>
  </div>
</div>

<div class="section">
  <h2>å…¨å®¶æ•°æ®åŒæ­¥</h2>
  <button class="sync-btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®ï¼ˆå¤åˆ¶åˆ°ç¾¤ï¼‰</button>
  <button class="sync-btn" onclick="importDataPrompt()">ğŸ“¥ å¯¼å…¥æ•°æ®ï¼ˆä»ç¾¤ç²˜è´´ï¼‰</button>
  <p style="font-size:14px;color:#666;margin-top:10px;">æ”¹å®Œæ•°æ®åå¯¼å‡ºå‘ç¾¤ï¼Œå…¶ä»–äººå¯¼å…¥å°±èƒ½åŒæ­¥äº†ï½</p>
</div>

<div style="text-align:center;margin:60px 0;">
  <button onclick="resetAll()" style="background:#ff3b30;padding:16px 40px;font-size:17px;border-radius:12px;">å…¨éƒ¨æ¸…ç©ºæ•°æ®</button>
</div>

<div class="footer">å‘±å‘±ä¸“å±å¦ˆå¦ˆç¥å™¨ v5.1 â€¢ æ•°æ®é€šè¿‡ç¾¤å…±äº«åŒæ­¥ â€¢ 2025å¹´5æœˆ28æ—¥å‡ºç”Ÿ</div>

<script>
// ==================== åŸºç¡€æ•°æ® ====================
const BIRTHDAY = new Date('2025-05-28');
const ONE_YEAR = new Date('2026-05-28');
const WEEKDAYS = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];

let records = JSON.parse(localStorage.getItem('baby_v5_records')) || [{date:"2025-05-28",height:50,weight:3.3,head:34}];

const suppliesConfig = [
  ["å°¿ä¸æ¹¿","ç‰‡",300,7,50],["æ£‰æŸ”å·¾","åŒ…",50,0.33,7],["å¥½å¥‡æ£‰æŸ”å·¾","åŒ…",50,0.33,7],
  ["å¥¶ç²‰","ç½",20,0.18,2],["ADæ»´å‰‚","ç²’",180,1,30],["å£æ°´è†","æ”¯",10,0.1,7],
  ["çº½å¼ºé¢éœœ","ç“¶",5,0.033,7],["ç±³ç²‰","è¢‹",10,0.07,7],["æ ¸æ¡ƒæ²¹","ç“¶",5,0.033,7],["æ´—æ¶¤å‰‚","ç“¶",5,0.033,7]
];
let supplies = JSON.parse(localStorage.getItem('baby_v5_supplies')) || suppliesConfig.map(c=>({name:c[0],unit:c[1],stock:c[2],daily:c[3],warn:c[4]}));

const allFoods = ["ç±³ç²‰","å—ç“œæ³¥","èƒ¡èåœæ³¥","è¥¿å…°èŠ±æ³¥","åœŸè±†æ³¥","è‹¹æœæ³¥","é¦™è•‰æ³¥","ç‰›æ²¹æœæ³¥","é¸¡è›‹é»„æ³¥","é³•é±¼æ³¥"];
let weekPlan = JSON.parse(localStorage.getItem('baby_v5_weekplan')) || [];

let allergies = JSON.parse(localStorage.getItem('baby_v5_allergies')) || {
  testing: [], passed: [], pending: allFoods.slice()
};

let todos = JSON.parse(localStorage.getItem('baby_v5_todos')) || [];

// ==================== ä¿å­˜ ====================
function saveAll(){
  localStorage.setItem('baby_v5_records', JSON.stringify(records));
  localStorage.setItem('baby_v5_supplies', JSON.stringify(supplies));
  localStorage.setItem('baby_v5_weekplan', JSON.stringify(weekPlan));
  localStorage.setItem('baby_v5_allergies', JSON.stringify(allergies));
  localStorage.setItem('baby_v5_todos', JSON.stringify(todos));
}

// ==================== å¹´é¾„å€’è®¡æ—¶ ====================
function updateAge(){
  const today = new Date();
  const totalDays = Math.floor((today - BIRTHDAY)/86400000);
  const months = Math.floor(totalDays/30), days = totalDays%30;
  document.getElementById('ageText').textContent = `å‘±å‘±ç°åœ¨ ${months} ä¸ªæœˆ ${days} å¤©`;
  document.getElementById('to1year').textContent = `è¿˜å‰© ${Math.ceil((ONE_YEAR-today)/86400000)} å¤©`;
}
updateAge(); setInterval(updateAge,60000);

// ==================== ç”Ÿé•¿æ›²çº¿ ====================
const WHO_HEIGHT = {0:[47,48,49,50,51,52,53],1:[51,52,53,54,55,56,57],2:[54,55,56,57,58,59,60],3:[57,58,59,60,61,62,63],4:[60,61,62,63,64,65,66],5:[62,63,64,65,66,67,68],6:[64,65,66,67,68,69,70],7:[66,67,68,69,70,71,72],8:[68,69,70,71,72,73,74],9:[69,70,71,72,73,74,75],10:[71,72,73,74,75,76,77],11:[72,73,74,75,76,77,78],12:[73,74,75,76,77,78,79]};
const WHO_WEIGHT = {0:[2.5,2.8,3.0,3.3,3.6,3.9,4.2],1:[3.4,3.7,4.0,4.3,4.7,5.1,5.4],2:[4.3,4.7,5.0,5.4,5.8,6.3,6.7],3:[5.0,5.4,5.8,6.2,6.7,7.2,7.7],4:[5.6,6.0,6.4,6.9,7.4,8.0,8.5],5:[6.1,6.5,6.9,7.4,8.0,8.6,9.2],6:[6.5,6.9,7.4,7.9,8.5,9.1,9.7],7:[6.9,7.3,7.8,8.3,8.9,9.6,10.2],8:[7.2,7.6,8.1,8.6,9.2,9.9,10.6],9:[7.5,7.9,8.4,8.9,9.6,10.3,11.0],10:[7.7,8.1,8.6,9.2,9.9,10.6,11.3],11:[7.9,8.3,8.9,9.4,10.1,10.9,11.6],12:[8.1,8.5,9.1,9.6,10.3,11.1,11.8]};

function getMonth(d){return Math.floor((new Date(d)-BIRTHDAY)/(30*86400000));}

function drawChart(){
  const c=document.getElementById('growthChart'),ctx=c.getContext('2d');
  c.width=c.offsetWidth*2; c.height=600;
  ctx.clearRect(0,0,c.width,c.height);
  const w=c.width,h=c.height,p=60;

  // WHOå‚è€ƒçº¿
  for(let i=0;i<7;i++){
    ctx.strokeStyle=i===3?'#ccc':'#eee';
    ctx.setLineDash(i===3?[6,6]:[]);
    ctx.beginPath();
    for(let m=0;m<=12;m++){
      const x=p+(w-2*p)*(m/12);
      const y=h-p-(h-2*p)*((WHO_HEIGHT[m]?WHO_HEIGHT[m][i]:48+i*4-45)/(85-45));
      m===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.stroke();
  }
  ctx.setLineDash([]);

  // èº«é«˜æ›²çº¿
  ctx.strokeStyle='#ff6b81'; ctx.lineWidth=6;
  ctx.beginPath();
  records.forEach((r,i)=>{
    const x=p+(w-2*p)*(getMonth(r.date)/12);
    const y=h-p-(h-2*p)*((r.height-45)/(85-45));
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    ctx.fillStyle='#ff6b81'; ctx.beginPath(); ctx.arc(x,y,12,0,Math.PI*2); ctx.fill();
  });
  ctx.stroke();

  // ä½“é‡æ›²çº¿
  ctx.strokeStyle='#54a0ff'; ctx.lineWidth=6;
  ctx.beginPath();
  records.forEach((r,i)=>{
    const x=p+(w-2*p)*(getMonth(r.date)/12);
    const y=h-p-(h-2*p)*((r.weight-2)/(13-2));
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    ctx.beginPath(); ctx.arc(x,y,12,0,Math.PI*2); ctx.fillStyle='#54a0ff'; ctx.fill();
  });
  ctx.stroke();
}

function addRecord(){
  const d=document.getElementById('newDate').value;
  const h=+document.getElementById('newHeight').value;
  const w=+document.getElementById('newWeight').value;
  if(!d||!h||!w) return alert('è¯·å¡«å†™æ—¥æœŸã€èº«é«˜ã€ä½“é‡');
  records.push({date:d,height:h,weight:w,head:+document.getElementById('newHead').value||null});
  records.sort((a,b)=>new Date(a.date)-new Date(b.date));
  saveAll(); drawChart(); renderRecords();
}

function deleteRecord(index){
  if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')){
    records.splice(index,1);
    saveAll(); drawChart(); renderRecords();
  }
}

function renderRecords(){
  const list=document.getElementById('recordList');
  list.innerHTML = records.map((r,i)=>`
    <div class="record-item">
      <div><strong>${r.date} ${WEEKDAYS[new Date(r.date).getDay()]}ï¼ˆ${getMonth(r.date)}ä¸ªæœˆï¼‰</strong></div>
      <div>èº«é«˜ ${r.height}cmâ€ƒä½“é‡ ${r.weight}kg${r.head?`â€ƒå¤´å›´ ${r.head}cm`:''}</div>
      <button onclick="deleteRecord(${i})" style="background:#ff3b30;font-size:13px;padding:5px 10px;">åˆ é™¤</button>
    </div>
  `).join('');
}

// ==================== è€—æåº“å­˜ ====================
function renderSupplies(){
  const el=document.getElementById('supplies'); el.innerHTML='';
  supplies.forEach((s,i)=>{
    const days = s.daily>0 ? Math.floor(s.stock/s.daily) : 999;
    const warn = days<=s.warn ? 'warn' : '';
    el.innerHTML += `
      <div class="item">
        <div class="item-name">${s.name}</div>
        <div class="item-input">
          <input type="number" value="${s.stock}" onchange="supplies[${i}].stock=Math.max(0,parseFloat(this.value)||0);saveAll();renderSupplies()">
          <button onclick="supplies[${i}].stock+=1;saveAll();renderSupplies()">+1${s.unit}</button>
        </div>
        <div class="item-stock ${warn}">å‰© ${s.stock}${s.unit}ï¼ˆçº¦${days}å¤©ï¼‰</div>
      </div>`;
  });
}

// ==================== è¾…é£Ÿè®¡åˆ’ ====================
function renderFoodPool(){
  const p=document.getElementById('foodPool'); p.innerHTML='';
  allFoods.forEach(f=>{
    const d=document.createElement('div');
    d.className='food' + (weekPlan.includes(f)?' selected':'');
    d.textContent=f;
    d.onclick=()=>{const idx=weekPlan.indexOf(f);idx>-1?weekPlan.splice(idx,1):weekPlan.push(f);saveAll();renderFoodPool();renderWeekPlan();};
    p.appendChild(d);
  });
}
function renderWeekPlan(){
  const el=document.getElementById('weekPlan');
  el.innerHTML = weekPlan.length ?
    weekPlan.map(f=>`<span class="tag" style="background:#ff8ba7;color:#fff;">${f}</span>`).join(' ') :
    '<span style="color:#999;">ç‚¹å‡»ä¸Šæ–¹é£ŸæåŠ å…¥æœ¬å‘¨è®¡åˆ’ï½</span>';
}

// ==================== æ’æ•ç³»ç»Ÿ ====================
function renderAllergy(){
  // è‡ªåŠ¨ç»“æŸ3å¤©è§‚å¯ŸæœŸ
  const now = new Date();
  allergies.testing = allergies.testing.filter(item=>{
    const end = new Date(item.start);
    end.setDate(end.getDate()+3);
    if(end <= now){
      allergies.passed.push(item.food);
      return false;
    }
    return true;
  });

  // å¡«å……ä¸‹æ‹‰æ¡†
  const sel=document.getElementById('newAllergy');
  sel.innerHTML='<option value="">é€‰æ‹©å¼€å§‹æ’æ•çš„é£Ÿæ</option>';
  allergies.pending.forEach(f=>{
    const opt=document.createElement('option');
    opt.value=f; opt.textContent=f; sel.appendChild(opt);
  });

  // æ˜¾ç¤º
  document.getElementById('testingList').innerHTML = allergies.testing.map(t=>{
    const end=new Date(t.start); end.setDate(end.getDate()+3);
    return `<span class="tag testing">${t.food}ï¼ˆ${t.start} â†’ ${end.toISOString().slice(0,10)}ï¼‰
      <button onclick="markPassed('${t.food}')" style="font-size:10px;padding:2px 6px;margin-left:6px;">é€šè¿‡</button>
      <button onclick="deleteTesting('${t.food}')" style="font-size:10px;padding:2px 6px;background:#ff3b30;">åˆ </button>
    </span>`;
  }).join('');

  document.getElementById('passedList').innerHTML = allergies.passed.map(f=>`<span class="tag passed">${f}</span>`).join('');
  document.getElementById('pendingList').innerHTML = allergies.pending.map(f=>`<span class="tag pending">${f}</span>`).join('');
}

function startAllergy(){
  const food=document.getElementById('newAllergy').value;
  if(!food) return alert('è¯·é€‰æ‹©é£Ÿæ');
  allergies.testing.push({food, start:new Date().toISOString().slice(0,10)});
  allergies.pending.splice(allergies.pending.indexOf(food),1);
  saveAll(); renderAllergy();
}
function markPassed(food){
  allergies.testing = allergies.testing.filter(t=>t.food!==food);
  if(!allergies.passed.includes(food)) allergies.passed.push(food);
  saveAll(); renderAllergy();
}
function deleteTesting(food){
  allergies.testing = allergies.testing.filter(t=>t.food!==food);
  if(!allergies.pending.includes(food)) allergies.pending.push(food);
  saveAll(); renderAllergy();
}

// ==================== å¾…åŠäº‹é¡¹ ====================
function renderTodos(){
  const el=document.getElementById('todos'); el.innerHTML='';
  todos.forEach((t,i)=>{
    const dateMatch = t.text.match(/(\d{4}[-.]\d{1,2}[-.]\d{1,2})/);
    const week = dateMatch ? WEEKDAYS[new Date(dateMatch[0]).getDay()] : '';
    el.innerHTML += `
      <div class="item">
        <input type="checkbox" ${t.done?'checked':''} onchange="todos[${i}].done=this.checked;saveAll();renderTodos()">
        <label style="flex:1;${t.done?'text-decoration:line-through;opacity:0.6;':''}">${t.text} ${week?`<span style="color:#ff6b81;font-size:14px;">${week}</span>`:''}</label>
        <button onclick="todos.splice(${i},1);saveAll();renderTodos()" style="background:#ff3b30;font-size:13px;">åˆ é™¤</button>
      </div>`;
  });
}
function addTodo(){
  const input=document.getElementById('newTodo');
  const text=input.value.trim();
  if(!text) return;
  todos.push({text, done:false});
  input.value=''; saveAll(); renderTodos();
}

// ==================== æ•°æ®åŒæ­¥ ====================
function exportData() {
  const allData = { records, supplies, weekPlan, allergies, todos };
  const json = JSON.stringify(allData);
  navigator.clipboard.writeText(json).then(() => alert('æ•°æ®å·²å¤åˆ¶ï¼å‘åˆ°ç¾¤é‡Œè®©å®¶äººå¯¼å…¥ï½'));
}

function importDataPrompt() {
  const json = prompt('ä»ç¾¤é‡Œç²˜è´´ JSON æ•°æ®ï¼š');
  if (json) {
    try {
      const data = JSON.parse(json);
      records = data.records || [];
      supplies = data.supplies || [];
      weekPlan = data.weekPlan || [];
      allergies = data.allergies || {};
      todos = data.todos || [];
      saveAll();
      location.reload(); // åˆ·æ–°æ˜¾ç¤ºæ–°æ•°æ®
      alert('å¯¼å…¥æˆåŠŸï¼é¡µé¢å·²åˆ·æ–°ï½');
    } catch (e) {
      alert('JSON æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç²˜è´´çš„å†…å®¹');
    }
  }
}

// ==================== æ¸…ç©ºæ•°æ® ====================
function resetAll(){
  if(confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨æ•°æ®å—ï¼Ÿï¼ˆä¸å¯æ¢å¤ï¼‰')){
    localStorage.clear();
    location.reload();
  }
}

// ==================== åˆå§‹åŒ– ====================
drawChart();
renderRecords();
renderSupplies();
renderFoodPool();
renderWeekPlan();
renderAllergy();
renderTodos();
</script>
</body>
</html>